(()=>{"use strict";function e(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}let t;const n=document.getElementById("btn-notification"),o=n.getElementsByTagName("img")[0];function i(e){let t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),o=new Uint8Array(n.length);for(let e=0;e<n.length;++e)o[e]=n.charCodeAt(e);return o}function a(e){let t=document.getElementsByTagName("article");for(let e of t)e.setAttribute("hidden","true");document.getElementById(e).removeAttribute("hidden")}async function r(n){let o;if("canvas"===n){let e=document.getElementById("taken-photo").toDataURL("image/png").split(","),t=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=new Uint8Array(n.length);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);o=new Blob([i],{type:t}),console.log(o)}else"file"===n&&(o=document.getElementById("file").files[0]);try{if(!1 in navigator)throw new Error("Service worker not in navigator");const n=(new Date).toISOString();await function(n,o,i=function(){return t||(t=function(t,n){const o=indexedDB.open("keyval-store");o.onupgradeneeded=()=>o.result.createObjectStore(n);const i=e(o);return(e,t)=>i.then((o=>t(o.transaction(n,e).objectStore(n))))}(0,"keyval")),t}()){return i("readwrite",(t=>(t.put(o,n),e(t.transaction))))}(n,{id:n,blob:o});let i=await navigator.serviceWorker.ready;await i.sync.register("sync-photos")}catch(e){console.log("You can not use sync option!"),(await fetch("/api/posts",{method:"POST",body:o})).ok||alert("Post failed")}a("video-article")}document.getElementById("btn-post").addEventListener("click",(async e=>{await r("canvas")})),document.getElementById("btn-upload").addEventListener("click",(async e=>{await r("file")})),document.getElementById("btn-discard").addEventListener("click",(e=>{a("video-article")})),document.getElementById("btn-take").addEventListener("click",(e=>{let t=document.getElementById("player"),n=document.getElementById("taken-photo"),o=t.videoWidth,i=t.videoHeight;n.width=o,n.height=i,n.getContext("2d").drawImage(t,0,0,o,i),a("canvas-article")})),"mediaDevices"in navigator?(navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((function(e){document.getElementById("player").srcObject=e,a("video-article")})).catch((function(e){console.log(e),a("upload-article")})),navigator.serviceWorker.ready.then((e=>e.sync.register("sync-photos"))).then((e=>{console.log("Sync done")}))):a("upload-article"),"Notification"in window&&"serviceWorker"in navigator?(n.addEventListener("click",(function(){Notification.requestPermission((async e=>{"granted"===e?await async function(){try{let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(null!==t)return o.src="icons/notification.png",await t.unsubscribe(),void console.log("SUBSCRIPTION: removing");o.src="icons/notification-full.png",t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:i("BKvPLsLUmpFn4uApO81fP1vDZfuKL3Q7eki6lp4t-g1f38vHNqQ0MmvlWeqSVBOK5U3gvCprmf6Sj1414GAXgkI")}),console.log(JSON.stringify(t)),(await fetch("/api/subscriptions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sub:t})})).ok?console.log("SUBSCRIPTION: granted"):(console.log("SUBSCRIPTION: failed because res is not ok"),o.src="icons/notification.png",await t.unsubscribe())}catch(e){console.log(e)}}():console.log("PUSH: user denied push notifications")}))})),navigator.serviceWorker.ready.then((e=>{e.pushManager.getSubscription().then((e=>{o.src=null===e?"icons/notification.png":"icons/notification-full.png",console.log(`Sub is ${e}`)}))}))):(console.log("PUSH: Notifications are not available"),n.style.backgroundColor="#a0c0e0")})();